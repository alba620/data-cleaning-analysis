---
title: |
  | Limpieza y análisis de datos
  | del mercado inmobiliario
author:
- Alba Gómez Varela
- Patricia Lázaro Tello
date: ''
output:
  html_document:
    toc: no
    df_print: paged
  pdf_document:
    keep_tex: no
    latex_engine: xelatex
    highlight: tango
    df_print: default
    number_section: yes
    toc: no
fontsize: 12pt
bibliography: real-estate.bib
nocite: '@*'
lang: es
header-includes: "\\usepackage{amsmath}\n\\usepackage{amssymb}\n\\usepackage{xcolor}\n\\usepackage{graphicx}\n\\usepackage[font=footnotesize,labelfont=bf]{caption}\n%\\usepackage[hidelinks]{hyperref}\n\\usepackage{fontspec}\n\\usepackage{fancyhdr}\n\\usepackage{titling}\n\\usepackage{array}\n\\usepackage{multicol}\n\\usepackage{framed}\n\\usepackage{enumitem}\n\\usepackage{soul}\n\\usepackage{subcaption}\n\\usepackage{wrapfig}\n\\usepackage{listings}\n\\usepackage{layout}\n\\usepackage{polyglossia}\n\\usepackage{csquotes}\n\\setdefaultlanguage{spanish}\n\\usepackage[language=spanish,
  bibstyle=numeric, citestyle=numeric, sorting=nyt]{biblatex}\n\n\\geometry{a4paper,top=2cm,left=3cm,right=1.5cm,marginparwidth=1.75cm}\n\n\\definecolor{uocblue}{HTML}{000078}\n\\colorlet{uocresalt}{white!93!uocblue}\n\\sethlcolor{uocresalt}\n\\colorlet{main}{uocblue}\n\\setmainfont{Arial}[Color
  = uocblue]\n\\renewcommand{\\labelitemi}{$\\textcolor{uocblue}{\\bullet}$}\n\\renewcommand{\\labelitemii}{$\\textcolor{uocblue}{\\cdot}$}\n\\renewcommand{\\labelitemiii}{$\\textcolor{uocblue}{\\diamond}$}\n\\renewcommand{\\labelitemiv}{$\\textcolor{uocblue}{\\ast}$}\n\\renewcommand{\\thefootnote}{\\textbf{\\arabic{footnote}}}\n\\renewcommand{\\footnoterule}{{\n\t\t\\color{uocblue}\n\t\t\\kern
  20pt\n\t\t\\hrule width 2in\n\t\t\\kern 3pt\n}}\n\\setulcolor{uocblue}\n\n\\setcounter{biburllcpenalty}{7000}\n\\setcounter{biburlucpenalty}{8000}\n\n\\hypersetup{allcolors=uocblue}\n\\urlstyle{same}\n\n\n\\makeatletter\n\\def\\@xobeysp{\\mbox{}\\space}\n\\def\\verbatim@font{\\color{uocblue}\\footnotesize\\ttfamily\\raggedright}\n\\makeatother\n\n\\RecustomVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\\\\{\\},
  fontsize=\\small}\n\\renewcommand{\\and}{\\\\}\n\n\n%%%%%%%%%%%%%%%%%\n\\newcommand{\\master}{Máster
  en Ciencia de Datos}\n\\newcommand{\\grade}{2021/2022}\n\\newcommand{\\subject}{Tipología
  y ciclo de vida del dato}\n\\newcommand{\\testname}{\\textbf{PRA2}}\n\\newcommand{\\loginuocone}{agomezvarela@uoc.edu}\n\\newcommand{\\loginuoctwo}{plazarotello@uoc.edu}\n\\newcommand{\\authorone}{Alba
  Gómez Varela}\n\\newcommand{\\authortwo}{Patricia Lázaro Tello}\n\\title{Limpieza
  y análisis de datos del mercado inmobiliario}\n\\author{Alba Gómez Varela\\\\Patricia
  Lázaro Tello}\n\\date{}\t% quitar la fecha del titulo\n%%%%%%%%%%%%%%%%%\n\n\\pretitle{\\vspace{-2cm}\\begin{center}\\LARGE
  \\bfseries}\n\\posttitle{\\end{center}}\n\\preauthor{\\vspace{-0.0065cm}\\begin{center}\n\t\t\\large
  \\itshape\n\t\t\\begin{tabular}[t]{c}}\n\t\t\\postauthor{\\end{tabular}\\end{center}\\vspace{-1.5cm}}\n\t\t\n\n\\fancypagestyle{uoc}{\n\\fancyhf{}\n\\fancyhead[C]{\\includegraphics[width=16.5cm]{uoc.png}}\n\\fancyhead[R]{\\footnotesize
  \\hspace*{\\fill}\\authorone \\space \\space · \\space \\nolinkurl{\\loginuocone}\\\\\n\t\\hspace*{\\fill}\\authortwo
  \\space \\space \\space · \\space\\space\\space \\nolinkurl{\\loginuoctwo}\\\\ \\vspace{-2pt}}\n\\fancyfoot[R]{\\footnotesize
  \\thepage} %\\hspace{0.5cm}}\n\\fancyfoot[C]{\\footnotesize \\hspace{1.5cm} \\grade}\n\\fancyfoot[L]{\\footnotesize
  \\subject \\space · \\testname\\\\\n\t\\space\\master}\n\\renewcommand{\\headrulewidth}{0pt}
  % remove lines as well\n\\renewcommand{\\footrulewidth}{0pt}\n\\setlength{\\footskip}{20pt}%\n\\setlength{\\headsep}{15pt}\n\\setlength{\\headheight}{42pt}\n\\setlength{\\parskip}{7.5pt}\n\\setlength{\\baselineskip}{1pt}\n\\setlength{\\topmargin}{-1cm}\n%\\setlength{\\textheight}{\\textheight}\n\\setlength{\\textheight}{680pt}\n\\setlength{\\oddsidemargin}{0pt}\n\\setlength{\\marginparsep}{0pt}\n\\setlength{\\marginparpush}{0pt}\n\\setlength{\\voffset}{-10pt}\n\\setlength{\\fboxsep}{0pt}\n}\n\n\\fancypagestyle{plain}{\n\\fancyhf{}\n\\fancyhead[C]{\\includegraphics[width=16.5cm]{uoc.png}}\n\\fancyhead[R]{\\footnotesize
  \\hspace*{\\fill}\\authorone \\space \\space · \\space \\nolinkurl{\\loginuocone}\\\\\n\t\\hspace*{\\fill}\\authortwo
  \\space \\space \\space · \\space\\space\\space \\nolinkurl{\\loginuoctwo}\\\\ \\vspace{-2pt}}\n\\fancyfoot[R]{\\footnotesize
  \\thepage} %\\hspace{0.5cm}}\n\\fancyfoot[C]{\\footnotesize \\hspace{1.5cm} \\grade}\n\\fancyfoot[L]{\\footnotesize
  \\subject \\space · \\testname\\\\\n\t\\space\\master}\n\\renewcommand{\\headrulewidth}{0pt}
  % remove lines as well\n\\renewcommand{\\footrulewidth}{0pt}\n\\setlength{\\footskip}{20pt}%\n\\setlength{\\headsep}{15pt}\n\\setlength{\\headheight}{42pt}\n\\setlength{\\parskip}{7.5pt}\n\\setlength{\\baselineskip}{1pt}\n\\setlength{\\topmargin}{-1cm}\n%\\setlength{\\textheight}{\\textheight}\n\\setlength{\\textheight}{680pt}\n\\setlength{\\oddsidemargin}{0pt}\n\\setlength{\\marginparsep}{0pt}\n\\setlength{\\marginparpush}{0pt}\n\\setlength{\\voffset}{-10pt}\n\\setlength{\\fboxsep}{0pt}\n}\n\n\\pagestyle{uoc}\n\\linespread{1.125}\n\\color{uocblue}\n"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE,
                      fig.align = 'center', fig.height = 4, fig.width = 9, dpi = 256)
options(scipen=99999, digits=2)
knitr::knit_hooks$set(inline = function(x) {
  if(!is.numeric(x)){x}
  else{prettyNum(round(x,2), big.mark='.', decimal.mark=',')}
  })
# carga de librerias
if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if (!require('tidyr')) install.packages('tidyr'); library('tidyr')
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require('caret')) install.packages('caret'); library('caret')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('GGally')) install.packages('GGally'); library('GGally')
if (!require('scales')) install.packages('scales'); library('scales')
if (!require('RColorBrewer')) install.packages('RColorBrewer'); library('RColorBrewer')
if(!require('ggpubr')) install.packages('ggpubr'); library('ggpubr')
if(!require('flextable')) install.packages('flextable'); library('flextable')
# definicion de colores
default.color.main <- '#F8766D'
default.color.secondary <- '#00BFC4'
default.color.terciary <- '#7CAE00'
default.color.quat <- '#6C25BE'
default.color.cinq <- '#FFB800'
default.color.six <- '#1C1D21'
default.color.seven <- '#003049'
default.color.eight <- '#8A2E3A'
default.color.nine <- '#093824'
# beautify plots
ggally.dist.aes <- list(continuous=wrap('points', shape=21))
palette <- c(default.color.main, default.color.secondary, 
             default.color.terciary, default.color.quat,
             default.color.cinq, default.color.six,
             default.color.seven, default.color.eight, default.color.nine)
palette.binary <- c(default.color.main, default.color.secondary)
title.centered <- theme(
  plot.title=element_text(face='bold', hjust=0.5, vjust=0.5, size=16),
  plot.title.position='plot',
  axis.title.x=element_text(size=12),
  axis.title.y=element_text(size=12),
  plot.subtitle=element_text(face='plain', hjust=0.5, vjust=0.5, size=11,
                             colour='grey50')
  )
no.axis.y <- theme(axis.text.y=element_blank(), axis.ticks.y=element_blank())
no.axis.x <- theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())
# seed
seed <- 50L
set.seed(seed)
```

\begin{center}
	\vspace{0.25cm}
	{\color{uocblue}\rule{\linewidth}{2pt}}
	\vspace{-0.75cm}
\end{center}

# Introducción y descripción del *dataset*

# Integración, selección y transformación de datos

En primer lugar, se procede a **cargar los datos** *raw* obtenidos del repositorio [Zenodo](https://zenodo.org/record/6423459), creado el 7 de abril de 2022 para la Práctica 1 de esta asignatura. En dicho fichero, ya se encuentran integrados los registros obtenidos tras el proceso de *scraping* de Idealista y de Fotocasa, por lo que no es necesario realizar de nuevo el proceso para la fusión de los datos:

```{r}
houses.raw <- read.csv('../data/real-estate-raw.csv', header=TRUE, sep=',', 
                       stringsAsFactors=FALSE, fileEncoding='UTF-8')
houses.raw.dim <- dim(houses.raw)
```

Se han cargado `r houses.raw.dim[1]` registros con `r houses.raw.dim[2]` campos asociados a cada registro. Se procede a mostrar los nombres de los **campos y un ejemplo** para comprender mejor la estructura del conjunto de datos original gracias a la función *peek.dataset* creada para tal efecto, y que puede consultarse en el script *real-estate-cleaning-analysis.rmd*:

```{r}
head(houses.raw, n=10)
```

Para finalizar la fase de integración de los datos, se eliminan las **viviendas duplicadas**, es decir, aquellos anuncios que contengan la misma vivienda en venta. Para ello, se evalúa cuáles tienen idéntico el campo *description*, puesto que pueden ser anuncios diferentes (con diferente *id* o *source*) pero con el mismo contenido. 

```{r include=FALSE}
duplicated.houses <- houses.raw[duplicated(houses.raw$description), ]
```

Así, por ejemplo, consecuencia del proceso de integración se pueden encontrar anuncios **procedentes de Fotocasa e Idealista** que contienen la misma vivienda (el *dataframe* completo de duplicados puede consultarse en el script *real-estate-cleaning-analysis.rmd*):

```{r}
duplicated_integration <- duplicated.houses[duplicated.houses$id == '161630827' | 
                                        duplicated.houses$id == '97136644', 
                                      c('description', 'source')]

flextable(data = data.frame(duplicated_integration)) %>% 
  theme_zebra %>% 
  autofit
```

Por otro lado, se observa como fenómeno que también existen viviendas ofertadas varias veces en el **mismo portal** inmobiliario:

```{r}
duplicated_source <- duplicated.houses[duplicated.houses$id == '96872707' | 
                                        duplicated.houses$id == '96872635'| 
                                      duplicated.houses$id == '96872687'|
                                      duplicated.houses$id == '96872637'|
                                      duplicated.houses$id == '96872706',
                                      c('description', 'source')]

flextable(data = data.frame(duplicated_source)) %>% 
  theme_zebra %>% 
  autofit
```

Con esta información, se deciden eliminar las **viviendas duplicadas** y, en caso de que se encuentre en ambos sitios web, se mantiene la vivienda de Fotocasa al contener información en el campo *rooms*, asunto que se trabajará más adelante. Fotocasas se selecciona por defecto porque es el primer registro que aparece en el *dataframe* original:

```{r}
houses.unique = houses.raw[!duplicated(houses.raw$description),]
```

Sin registros duplicados, se pasa a la selección de los datos de interés, que conlleva una reducción de la dimensionalidad. Se lista a continuación cada campo, una breve descripción del mismo y si se selecciona o no, así como los motivos de la decisión:

- **id**: identificador numérico para cada registro. Actúa como identificador único junto al campo *source*. Se decide mantener los campos identificadores.
- **url**: enlace a la página de venta de la vivienda Se descarta debido a que no se puede obtener más información de la ya obtenida en la práctica anterior y a que los anuncios pueden haber desaparecido.
- **title**: título del anuncio. Se descarta por no ofrecer información adicional.
- **location**: barrio en que se encuentra la vivienda anunciada. Puede ofrecer información relevante sobre la variabilidad de precios en el mercado inmobiliario y permite agrupar los anuncios por zonas. Será importante en la parte de análisis.
- **price**: precio en euros.
- **m2**: metros cuadrados de la vivienda. Permite distinguir el tamaño de las viviendas y realizar agrupaciones.
- **price.m2**: se creará una nueva variable que contenga el valor del precio por metro cuadrado en euros de la vivienda.
- **rooms**: número de habitaciones de la vivienda. Junto a **m2** permite describir sus características físicas.
- **floor**: altura a la que se encuentra la vivienda. Ayuda a las descripción de sus características físicas. 
- **num.photos**: número de fotos que acompañan al anuncio. Se puede analizar si existe correlación entre algún tipo de vivienda (caras, baratas, con peores o mejores características) y el número de fotos.
- **floor.plan**: valor lógico que indica si se ha adjuntado el plano de la casa al anuncio.
- **view3d**: valor lógico que indica si el anuncio cuenta con la característica de visión en 3D.
- **video**: valor lógico que indica si el anuncio cuenta con un vídeo de la vivienda
- **home.staging**: valor lógico que indica si el anuncio cuenta con la característica de *home staging*.
- **description**: descripción del cuerpo del anuncio. Se mantiene por si su análisis sirviera de utilidad en el análisis futuro, aunque un análisis textual supera el contexto de la asignatura. 
- **description_length**: se creará un campo nuevo ``description_length`` con el número de palabras contenidas en la descripción para futuros análisis.
- **photo_urls**: lista de los enlaces de las fotografías adjuntas al anuncio. Se descarta por no realizar un análisis de las fotografías.
- **source**: cadena de texto que indica la fuente de la que se ha extraído la información del anuncio. Solo existen los valores "idealista" y "fotocasa". Forma parte del identificador único de cara registro y sirve, además, para agrupar viviendas.

Como se ha observado que todos los campos se han codificado como cadenas de caracteres, se optimiza la fase de selección de datos realizando también la transformación del tipo de datos. Asím a continuación se eliminan las variables descartadas, se crean las nuevas y se transforman los datos:

```{r}
selected.houses <- houses.unique %>% dplyr::select(-url, -title, -photo_urls) %>%  
  dplyr::mutate(id=as.integer(id), 
                location=as.factor(location),
                price=as.integer(str_remove_all(price, '\\.')),
                m2=as.integer(m2), 
                price.m2 = as.double(price/m2),
                rooms=as.integer(rooms),floor=as.factor(floor), 
                num.photos=as.integer(num.photos), 
                floor.plan=as.logical(as.integer(floor.plan)),
                view3d=as.logical(as.integer(view3d)), 
                video=as.logical(as.integer(video)),
                home.staging=as.logical(as.integer(home.staging)),
                description=description,
                description.length=nchar(description),
                source=as.factor(source))
selected.houses.dim <- dim(selected.houses)

head(selected.houses, n=10)
```

Finalmente, debido a que la cantidad de registros no es muy elevada, se decide no reducirlos mediante ningún método.

Por tanto, el conjunto de datos con el que se trabajará durante el resto del estudio está compuesto de **`r selected.houses.dim[1]` registros** con **`r selected.houses.dim[2]` campos** por cada registro.

# Limpieza de los datos

Tras haber seleccionado los datos útiles, el siguiente paso en el análisis consiste en la limpieza y normalización de los datos. En esta fase, es necesario gestionar los registros con valores perdidos o **missing data**, así como comprobar la distribución de ciertos tipos de datos (por ejemplo, el precio de la vivienda o los m^2) para inspeccionar la existencia de valores extremos o **outliers**.

## Gestión de *Missing Data*

Se procede a realizar un análisis preliminar y superficial de los valores perdidos en todos los campos:

```{r}
colSums(is.na(selected.houses))
selected.houses[is.na(selected.houses$id) | is.na(selected.houses$price),]
```

Solo existe `r sum(is.na(selected.houses$id))` registro sin identificador y `r sum(is.na(selected.houses$price))` registro sin precio. Dadas las características de los registros (demasiados campos con valores perdidos y otros campos con valores incorrectos en el registro sin identificador) se decide eliminar los registros y se procede a analizar los registros con valores perdidos en el campo *rooms*.

```{r}
selected.houses <- selected.houses[!is.na(selected.houses$id) & 
                                     !is.na(selected.houses$price),]
selected.houses.dim <- dim(selected.houses)
```

```{r}
head(selected.houses[is.na(selected.houses$rooms),], n=10)
```


## Gestión de *outliers*

## Otras transformaciones

Varios de los campos del *dataset* son factores y pueden albergar valores ligeramente distintos que hagan referencia al mismo concepto. Se procede a comprobar los valores de estos campos y unificar los valores si es necesario.

```{r}
unique(selected.houses$location)
```


# Análisis de los datos

## Selección de grupos de datos

## Comprobación de normalidad y homocedasticidad

## Pruebas estadísticas

# Conclusiones

\newpage

# Bibliografía
