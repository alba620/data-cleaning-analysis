---
title: |
  | Limpieza y análisis de datos
  | del mercado inmobiliario
author:
  - Alba Gómez Varela
  - Patricia Lázaro Tello
date: ''
lang: es
fontsize: 12pt
bibliography: real-estate.bib
nocite: '@*'
output: 
  pdf_document:
    keep_tex: false
    latex_engine: "xelatex"
    highlight: tango
    df_print: default
    number_section: yes
    toc: no
header-includes: |
  \usepackage{amsmath}
  \usepackage{amssymb}
  \usepackage{xcolor}
  \usepackage{graphicx}
  \usepackage[font=footnotesize,labelfont=bf]{caption}
  %\usepackage[hidelinks]{hyperref}
  \usepackage{fontspec}
  \usepackage{fancyhdr}
  \usepackage{titling}
  \usepackage{array}
  \usepackage{multicol}
  \usepackage{framed}
  \usepackage{enumitem}
  \usepackage{soul}
  \usepackage{subcaption}
  \usepackage{wrapfig}
  \usepackage{listings}
  \usepackage{layout}
  \usepackage{polyglossia}
  \usepackage{csquotes}
  \setdefaultlanguage{spanish}
  \usepackage[language=spanish, bibstyle=numeric, citestyle=numeric, sorting=nyt]{biblatex}
  
  \geometry{a4paper,top=2cm,left=3cm,right=1.5cm,marginparwidth=1.75cm}
  
  \definecolor{uocblue}{HTML}{000078}
  \colorlet{uocresalt}{white!93!uocblue}
  \sethlcolor{uocresalt}
  \colorlet{main}{uocblue}
  \setmainfont{Arial}[Color = uocblue]
  \renewcommand{\labelitemi}{$\textcolor{uocblue}{\bullet}$}
  \renewcommand{\labelitemii}{$\textcolor{uocblue}{\cdot}$}
  \renewcommand{\labelitemiii}{$\textcolor{uocblue}{\diamond}$}
  \renewcommand{\labelitemiv}{$\textcolor{uocblue}{\ast}$}
  \renewcommand{\thefootnote}{\textbf{\arabic{footnote}}}
  \renewcommand{\footnoterule}{{
  		\color{uocblue}
  		\kern 20pt
  		\hrule width 2in
  		\kern 3pt
  }}
  \setulcolor{uocblue}
  
  \setcounter{biburllcpenalty}{7000}
  \setcounter{biburlucpenalty}{8000}
  
  \hypersetup{allcolors=uocblue}
  \urlstyle{same}
  
  
  \makeatletter
  \def\@xobeysp{\mbox{}\space}
  \def\verbatim@font{\color{uocblue}\footnotesize\ttfamily\raggedright}
  \makeatother
  
  \RecustomVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}, fontsize=\small}
  \renewcommand{\and}{\\}
  
  
  %%%%%%%%%%%%%%%%%
  \newcommand{\master}{Máster en Ciencia de Datos}
  \newcommand{\grade}{2021/2022}
  \newcommand{\subject}{Tipología y ciclo de vida del dato}
  \newcommand{\testname}{\textbf{PRA2}}
  \newcommand{\loginuocone}{agomezvarela@uoc.edu}
  \newcommand{\loginuoctwo}{plazarotello@uoc.edu}
  \newcommand{\authorone}{Alba Gómez Varela}
  \newcommand{\authortwo}{Patricia Lázaro Tello}
  \title{Limpieza y análisis de datos del mercado inmobiliario}
  \author{Alba Gómez Varela\\Patricia Lázaro Tello}
  \date{}	% quitar la fecha del titulo
  %%%%%%%%%%%%%%%%%
  
  \pretitle{\vspace{-2cm}\begin{center}\LARGE \bfseries}
  \posttitle{\end{center}}
  \preauthor{\vspace{-0.0065cm}\begin{center}
  		\large \itshape
  		\begin{tabular}[t]{c}}
  		\postauthor{\end{tabular}\end{center}\vspace{-1.5cm}}
  		
  
  \fancypagestyle{uoc}{
  \fancyhf{}
  \fancyhead[C]{\includegraphics[width=16.5cm]{uoc.png}}
  \fancyhead[R]{\footnotesize \hspace*{\fill}\authorone \space \space · \space \nolinkurl{\loginuocone}\\
  	\hspace*{\fill}\authortwo \space \space \space · \space\space\space \nolinkurl{\loginuoctwo}\\ \vspace{-2pt}}
  \fancyfoot[R]{\footnotesize \thepage} %\hspace{0.5cm}}
  \fancyfoot[C]{\footnotesize \hspace{1.5cm} \grade}
  \fancyfoot[L]{\footnotesize \subject \space · \testname\\
  	\space\master}
  \renewcommand{\headrulewidth}{0pt} % remove lines as well
  \renewcommand{\footrulewidth}{0pt}
  \setlength{\footskip}{20pt}%
  \setlength{\headsep}{15pt}
  \setlength{\headheight}{42pt}
  \setlength{\parskip}{7.5pt}
  \setlength{\baselineskip}{1pt}
  \setlength{\topmargin}{-1cm}
  %\setlength{\textheight}{\textheight}
  \setlength{\textheight}{680pt}
  \setlength{\oddsidemargin}{0pt}
  \setlength{\marginparsep}{0pt}
  \setlength{\marginparpush}{0pt}
  \setlength{\voffset}{-10pt}
  \setlength{\fboxsep}{0pt}
  }
  
  \fancypagestyle{plain}{
  \fancyhf{}
  \fancyhead[C]{\includegraphics[width=16.5cm]{uoc.png}}
  \fancyhead[R]{\footnotesize \hspace*{\fill}\authorone \space \space · \space \nolinkurl{\loginuocone}\\
  	\hspace*{\fill}\authortwo \space \space \space · \space\space\space \nolinkurl{\loginuoctwo}\\ \vspace{-2pt}}
  \fancyfoot[R]{\footnotesize \thepage} %\hspace{0.5cm}}
  \fancyfoot[C]{\footnotesize \hspace{1.5cm} \grade}
  \fancyfoot[L]{\footnotesize \subject \space · \testname\\
  	\space\master}
  \renewcommand{\headrulewidth}{0pt} % remove lines as well
  \renewcommand{\footrulewidth}{0pt}
  \setlength{\footskip}{20pt}%
  \setlength{\headsep}{15pt}
  \setlength{\headheight}{42pt}
  \setlength{\parskip}{7.5pt}
  \setlength{\baselineskip}{1pt}
  \setlength{\topmargin}{-1cm}
  %\setlength{\textheight}{\textheight}
  \setlength{\textheight}{680pt}
  \setlength{\oddsidemargin}{0pt}
  \setlength{\marginparsep}{0pt}
  \setlength{\marginparpush}{0pt}
  \setlength{\voffset}{-10pt}
  \setlength{\fboxsep}{0pt}
  }
  
  \pagestyle{uoc}
  \linespread{1.125}
  \color{uocblue}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE,
                      fig.align = 'center', fig.height = 4, fig.width = 9, dpi = 256)
options(scipen=99999, digits=2)
knitr::knit_hooks$set(inline = function(x) {
  if(!is.numeric(x)){x}
  else{prettyNum(round(x,2), big.mark='.', decimal.mark=',')}
  })

# carga de librerias
if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if (!require('tidyr')) install.packages('tidyr'); library('tidyr')
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require('caret')) install.packages('caret'); library('caret')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('GGally')) install.packages('GGally'); library('GGally')
if (!require('scales')) install.packages('scales'); library('scales')
if (!require('RColorBrewer')) install.packages('RColorBrewer'); library('RColorBrewer')
if(!require('ggpubr')) install.packages('ggpubr'); library('ggpubr')

# definicion de colores
default.color.main <- '#F8766D'
default.color.secondary <- '#00BFC4'
default.color.terciary <- '#7CAE00'
default.color.quat <- '#6C25BE'
default.color.cinq <- '#FFB800'
default.color.six <- '#1C1D21'
default.color.seven <- '#003049'
default.color.eight <- '#8A2E3A'
default.color.nine <- '#093824'

# beautify plots
ggally.dist.aes <- list(continuous=wrap('points', shape=21))
palette <- c(default.color.main, default.color.secondary, 
             default.color.terciary, default.color.quat,
             default.color.cinq, default.color.six,
             default.color.seven, default.color.eight, default.color.nine)
palette.binary <- c(default.color.main, default.color.secondary)

title.centered <- theme(
  plot.title=element_text(face='bold', hjust=0.5, vjust=0.5, size=16),
  plot.title.position='plot',
  axis.title.x=element_text(size=12),
  axis.title.y=element_text(size=12),
  plot.subtitle=element_text(face='plain', hjust=0.5, vjust=0.5, size=11,
                             colour='grey50')
  )

no.axis.y <- theme(axis.text.y=element_blank(), axis.ticks.y=element_blank())
no.axis.x <- theme(axis.text.x=element_blank(), axis.ticks.x=element_blank())

# seed
seed <- 50L
set.seed(seed)
```

\begin{center}
	\vspace{0.25cm}
	{\color{uocblue}\rule{\linewidth}{2pt}}
	\vspace{-0.75cm}
\end{center}

# Introducción y descripción del *dataset*

# Integración y selección de datos

En primer lugar, se procede a cargar los datos *raw* obtenidos del repositorio [Zenodo](https://zenodo.org/record/6423459), creado el 7 de abril de 2022 para la práctica 1 de esta asignatura.

```{r}
houses.raw <- read.csv('../data/real-estate-raw.csv', header=TRUE, sep=',', 
                       stringsAsFactors=FALSE, fileEncoding='UTF-8')
houses.raw.dim <- dim(houses.raw)
```

Se han cargado `r houses.raw.dim[1]` registros con `r houses.raw.dim[2]` campos asociados a cada registro. Se procede a mostrar los nombres de los campos y un ejemplo para comprender mejor la estructura del conjunto de datos original:

```{r include=FALSE}
peek.dataset <- function(dataset){
  for (col in names(dataset)) {
    example = as.character(dataset[1,col])
    if(nchar(example) > 50){
      example = paste0(substr(example, start=1, stop=50), '...')
    }
    cat(paste0('Campo ', col, ' (', class(dataset[1,col]), '): ', example, '\n'))
  }
}
```

```{r}
peek.dataset(houses.raw)
```
Se observa que todos los campos se han codificado como cadenas de caracteres. Este será uno de los primeros errores a corregir, pero por motivos de optimización del tiempo y eficiencia, se ha decidido seleccionar primero el subconjunto de campos con el que se trabajará a lo largo de este estudio. Se listan a continuación cada campo, una breve descripción del mismo y si se selecciona o no, así como los motivos que llevan a su descarte.

- **id**: identificador numérico para cada registro. Actúa como identificador único junto al campo *source*. Se decide mantener los campos identificadores.
- **url**: enlace a la páginna de venta del piso. Se descarta debido a que no se puede obtener más información de la ya obtenida en la práctica anterior.
- **title**: título del anuncio. Se descarta por no ofrecer información adicional.
- **location**: barrio en que se encuentra el piso anunciado. Puede ofrecer información relevante sobre la variabilidad de precios en el mercado inmobiliario y permite agrupar los anuncios por zonas.
- **price**: precio en euros. Es la variable objetivo.
- **m2**: metros cuadrados del piso. Permite distinguir entre pisos pequeños y grandes.
- **rooms**: número de habitaciones del piso. Junto a **m2** permite distinguir las dimensiones del piso.
- **floor**: altura a la que se encuentra el piso. Es posible que pisos más altos tengan un mayor valor de mercado.
- **num.photos**: número de fotos que acompañan al anuncio. Se puede analizar si existe correlación entre algún tipo de vivienda (pisos caros, baratos, con peores o mejores características) y el número de fotos.
- **floor.plan**: valor lógico que indica si se ha adjuntado el plano de la casa al anuncio.
- **view3d**: valor lógico que indica si el anuncio cuenta con la característica de visión en 3D.
- **video**: valor lógico que indica si el anuncio cuenta con un vídeo del piso.
- **home.staging**: valor lógico que indica si el anuncio cuenta con la característica de *home staging*.
- **description**: descripción del cuerpo del anuncio. No se mantiene en el *dataset* por no poder ser analizada en mayor profundidad mediante análisis de textos (super el contexto de la asignatura). Sin embargo, se creará un campo nuevo ``description`` con el número de palabras contenidas en la descripción.
- **photo_urls**: lista de los enlaces de las fotografías adjuntas al anuncio. Se descarta por no realizar un análisis de las fotografías.
- **source**: cadena de texto que indica la fuente de la que se ha extraído la información del anuncio. Solo existen los valores "idealista" y "fotocasa". Forma parte del identificador único de cara registro.

```{r}
selected.houses <- houses.raw %>% dplyr::select(-url, -title, -photo_urls) %>%
  dplyr::mutate(id=as.integer(id), location=as.factor(location),
                price=as.integer(str_remove_all(price, '\\.')),m2=as.integer(m2), 
                rooms=as.integer(rooms),floor=as.factor(floor), 
                num.photos=as.integer(num.photos), 
                floor.plan=as.logical(as.integer(floor.plan)),
                view3d=as.logical(as.integer(view3d)), 
                video=as.logical(as.integer(video)),
                home.staging=as.logical(as.integer(home.staging)),
                description=nchar(description),
                source=as.factor(source))
selected.houses.dim <- dim(selected.houses)
peek.dataset(selected.houses)
```

El conjunto de datos con el que se trabajará durante el resto del estudio está compuesto de `r selected.houses.dim[1]` registros con `r selected.houses.dim[2]` campos por cada registro.

# Limpieza de los datos

Tras haber seleccionado los datos útiles, el siguiente paso en el análisis consiste en la limpieza y normalización de los datos. En esta fase, es necesario gestionar los registros con valores perdidos o **missing data**, así como comprobar la distribución de ciertos tipos de datos (por ejemplo, el precio de la vivienda o los m^2) para inspeccionar la existencia de valores extremos o **outliers**.

## Gestión de *Missing Data*

Se procede a realizar un análisis preliminar y superficial de los valores perdidos en todos los campos:

```{r}
colSums(is.na(selected.houses))
head(selected.houses[is.na(selected.houses$id) | 
                       is.na(selected.houses$price),], n=5)
```

Solo existe `r sum(is.na(selected.houses$id))` registro sin identificador y `r sum(is.na(selected.houses$price))` registro sin precio. Dadas las características de los registros (demasiados campos con valores perdidos y otros campos con valores incorrectos en el registro sin identificador) se decide eliminar los registros y se procede a analizar los registros con valores perdidos en el campo *rooms*.

```{r}
selected.houses <- selected.houses[!is.na(selected.houses$id) & 
                                     !is.na(selected.houses$price),]
selected.houses.dim <- dim(selected.houses)
```

```{r}
head(selected.houses[is.na(selected.houses$rooms),
                     c('id', 'location', 'rooms', 'source')], n=5)
```


## Gestión de *outliers*

## Otras transformaciones

Varios de los campos del *dataset* son factores y pueden albergar valores ligeramente distintos que hagan referencia al mismo concepto. Se procede a comprobar los valores de estos campos y unificar los valores si es necesario.

```{r}
unique(selected.houses$location)
```


# Análisis de los datos

## Selección de grupos de datos

## Comprobación de normalidad y homocedasticidad

## Pruebas estadísticas

# Conclusiones

\newpage

# Bibliografía
